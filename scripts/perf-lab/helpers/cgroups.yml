name: cgroups related scripts
scripts:
  join-cgroup:
    - set-signal: CGROUP_${{CGROUP_NAME:perf-cgroup}}_SET 1
    - wait-for: CGROUP_${{CGROUP_NAME:perf-cgroup}}_SET
    - read-state: ${{os}}
      then:
        - regex: linux
          then:
            - script: sudo
              with:
                command: echo ${{SHELL_PID}} >> /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/tasks/cgroup.procs
          else:
            - log: "Non-Linux OS doesn't support cgroups"
    - signal: CGROUP_${{CGROUP_NAME:perf-cgroup}}_DONE

  create-cgroup:
    - read-state: ${{os}}
      then:
        - regex: linux
          then:
            - script: sudo
              with:
                command: mkdir -p /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/tasks
            - script: sudo
              with:
                command: chown -R ${{env.USER}} /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/
            - script: sudo
              with:
                command: echo "+cpu" >>  /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/cgroup.subtree_control
            - script: sudo
              with:
                command: echo "+cpuset" >>  /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/cgroup.subtree_control
            - script: sudo
              with:
                command: echo "+memory" >>  /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/cgroup.subtree_control
            - read-state: ${{CGROUP_CPUSET}}
              then:
                - regex: .+
                  then:
                    - script: sudo
                      with:
                        command: echo ${{CGROUP_CPUSET}} > /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/tasks/cpuset.cpus
            - read-state: ${{CGROUP_MAX_MEM}}
              then:
                - regex: .+
                  then:
                    - script: sudo
                      with:
                        command: echo ${{CGROUP_MAX_MEM}} >  /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/tasks/memory.max
          else:
            - log: "Non-Linux OS doesn't support cgroups"

  delete-cgroup:
    - read-state: ${{os}}
      then:
        - regex: linux
          then:
            - script: sudo
              with:
                command: echo "-cpu" >>  /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/cgroup.subtree_control
            - script: sudo
              with:
                command: echo "-cpuset" >>  /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/cgroup.subtree_control
            - script: sudo
              with:
                command: echo "-memory" >>  /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/cgroup.subtree_control
            - script: sudo
              with:
                command: rmdir /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/tasks/
            - script: sudo
              with:
                command: rmdir /sys/fs/cgroup/${{CGROUP_NAME:perf-cgroup}}/
          else:
            - log: "Non-Linux OS doesn't support cgroups"
